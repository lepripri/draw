<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8">
<title>Pripri ‚Äì Dessin SVG</title>

<style>
/* ===== STYLE PRIPRI ===== */
html, body {
  margin: 0;
  padding: 0;
  background-color: #fcb1e3;
  font-family: Arial, sans-serif;
  height: 100%;
}

body {
  display: flex;
}

/* ===== BARRE OUTILS ===== */
#tools {
  width: 180px;
  background: #fcb1e3;
  border-right: 3px solid #ff0000;
  padding: 6px;
}

#tools button {
  width: 100%;
  background: white;
  border: 2px solid #ff0000;
  margin-bottom: 4px;
  padding: 4px;
  cursor: pointer;
}

#tools button:hover {
  background: #ffdddd;
}

/* ===== CANVAS ===== */
#canvas {
  flex: 1;
  background: white;
  border: 3px solid #ff0000;
  cursor: crosshair;
}

/* ===== SVG ELEMENTS ===== */
.selected {
  stroke: #ff0000 !important;
  stroke-width: 2;
}

.handle {
  fill: white;
  stroke: #ff0000;
  stroke-width: 1.5;
}

.rotate {
  fill: #ff0000;
  cursor: grab;
}
</style>
</head>

<body>

<div id="tools">
  <button onclick="setTool('select')">üñ± S√©lection</button>
  <button onclick="setTool('rect')">‚¨õ Rectangle</button>
  <button onclick="setTool('ellipse')">‚ö™ Ellipse</button>
  <button onclick="setTool('line')">üìè Ligne</button>
  <button onclick="setTool('text')">‚úè Texte</button>
  <hr>
  <button onclick="exportSVG()">üíæ Export SVG</button>
</div>

<svg id="canvas"></svg>

<script>
const svg = document.getElementById("canvas");
const ns = "http://www.w3.org/2000/svg";

let tool = "select";
let current = null;
let selected = null;
let startX = 0, startY = 0;
let handles = [];

/* ===== TOOLS ===== */
function setTool(t) {
  tool = t;
  removeHandles();
}

/* ===== DRAW ===== */
svg.addEventListener("mousedown", e => {
  startX = e.offsetX;
  startY = e.offsetY;

  if (tool === "select") {
    select(e.target);
    return;
  }

  current = create(tool, startX, startY);
  if (current) svg.appendChild(current);
});

svg.addEventListener("mousemove", e => {
  if (!current) return;

  const x = e.offsetX;
  const y = e.offsetY;

  if (current.tagName === "rect") {
    current.setAttribute("x", Math.min(x, startX));
    current.setAttribute("y", Math.min(y, startY));
    current.setAttribute("width", Math.abs(x - startX));
    current.setAttribute("height", Math.abs(y - startY));
  }

  if (current.tagName === "ellipse") {
    current.setAttribute("cx", (x + startX) / 2);
    current.setAttribute("cy", (y + startY) / 2);
    current.setAttribute("rx", Math.abs(x - startX) / 2);
    current.setAttribute("ry", Math.abs(y - startY) / 2);
  }

  if (current.tagName === "line") {
    current.setAttribute("x2", x);
    current.setAttribute("y2", y);
  }
});

svg.addEventListener("mouseup", () => current = null);

/* ===== CREATE ===== */
function create(t, x, y) {
  let e;

  if (t === "rect") {
    e = document.createElementNS(ns, "rect");
    e.setAttribute("fill", "none");
    e.setAttribute("stroke", "black");
  }

  if (t === "ellipse") {
    e = document.createElementNS(ns, "ellipse");
    e.setAttribute("fill", "none");
    e.setAttribute("stroke", "black");
  }

  if (t === "line") {
    e = document.createElementNS(ns, "line");
    e.setAttribute("x1", x);
    e.setAttribute("y1", y);
    e.setAttribute("x2", x);
    e.setAttribute("y2", y);
    e.setAttribute("stroke", "black");
  }

  if (t === "text") {
    const txt = prompt("Texte Pripri ?");
    if (!txt) return null;
    e = document.createElementNS(ns, "text");
    e.setAttribute("x", x);
    e.setAttribute("y", y);
    e.textContent = txt;
  }

  return e;
}

/* ===== SELECTION ===== */
function select(el) {
  if (el === svg) return;
  if (selected) selected.classList.remove("selected");
  selected = el;
  selected.classList.add("selected");
  createHandles();
}

/* ===== HANDLES ===== */
function createHandles() {
  removeHandles();
  if (!selected.getBBox) return;

  const b = selected.getBBox();
  const pts = [
    [b.x, b.y],
    [b.x + b.width, b.y],
    [b.x, b.y + b.height],
    [b.x + b.width, b.y + b.height]
  ];

  pts.forEach(p => {
    const h = document.createElementNS(ns, "rect");
    h.setAttribute("x", p[0] - 4);
    h.setAttribute("y", p[1] - 4);
    h.setAttribute("width", 8);
    h.setAttribute("height", 8);
    h.classList.add("handle");
    h.onmousedown = ev => resize(ev, p);
    svg.appendChild(h);
    handles.push(h);
  });

  const r = document.createElementNS(ns, "circle");
  r.setAttribute("cx", b.x + b.width / 2);
  r.setAttribute("cy", b.y - 20);
  r.setAttribute("r", 6);
  r.classList.add("rotate");
  r.onmousedown = startRotate;
  svg.appendChild(r);
  handles.push(r);
}

function removeHandles() {
  handles.forEach(h => h.remove());
  handles = [];
}

/* ===== RESIZE ===== */
function resize(e, origin) {
  e.stopPropagation();

  const isEllipse = selected.tagName === "ellipse";

  svg.onmousemove = ev => {
    const x = ev.offsetX;
    const y = ev.offsetY;

    const w = Math.abs(x - origin[0]);
    const h = Math.abs(y - origin[1]);

    if (isEllipse) {
      selected.setAttribute("rx", w / 2);
      selected.setAttribute("ry", h / 2);
      selected.setAttribute("cx", origin[0] + w / 2);
      selected.setAttribute("cy", origin[1] + h / 2);
    } else {
      selected.setAttribute("x", Math.min(x, origin[0]));
      selected.setAttribute("y", Math.min(y, origin[1]));
      selected.setAttribute("width", w);
      selected.setAttribute("height", h);
    }
  };

  svg.onmouseup = () => {
    svg.onmousemove = null;
    createHandles();
  };
}

/* ===== ROTATE ===== */
function startRotate(e) {
  e.stopPropagation();
  const b = selected.getBBox();
  const cx = b.x + b.width / 2;
  const cy = b.y + b.height / 2;

  svg.onmousemove = ev => {
    const a = Math.atan2(ev.offsetY - cy, ev.offsetX - cx) * 180 / Math.PI;
    selected.setAttribute("transform", `rotate(${a} ${cx} ${cy})`);
  };

  svg.onmouseup = () => svg.onmousemove = null;
}

/* ===== EXPORT ===== */
function exportSVG() {
  removeHandles();
  const blob = new Blob([svg.outerHTML], { type: "image/svg+xml" });
  download(blob, "pripri.svg");
  createHandles();
}

function download(blob, name) {
  const a = document.createElement("a");
  a.href = URL.createObjectURL(blob);
  a.download = name;
  a.click();
}
</script>

</body>
</html>
