<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8">
<title>Éditeur SVG Avancé</title>
<style>
body { margin:0; display:flex; height:100vh; font-family:Arial; }
#tools { width:220px; background:#eee; padding:10px; }
#tools button { width:100%; margin-bottom:5px; }
svg { flex:1; border-left:1px solid #aaa; cursor:crosshair; }

.selected { stroke:red !important; }
.handle { fill:white; stroke:black;}
.rotate { fill:yellow; cursor:grab; }
</style>
</head>
<body>

<div id="tools">
  <button onclick="setTool('select')">Sélection</button>
  <button onclick="setTool('rect')">Rectangle</button>
  <button onclick="setTool('ellipse')">Ovale</button>
  <button onclick="setTool('line')">Ligne</button>
  <button onclick="setTool('triangle')">Triangle</button>
  <button onclick="setTool('text')">Texte</button>
  <hr>
  <button onclick="exportSVG()">Exporter SVG</button>
  <button onclick="exportPNG()">Convertir en Bitmap</button>
</div>

<svg id="canvas"></svg>

<script>
const svg = document.getElementById("canvas");
const ns = "http://www.w3.org/2000/svg";
let tool="select", current=null, selected=null;
let startX,startY;
let handles=[];

/* ===================== TOOLS ===================== */
function setTool(t){ tool=t; removeHandles(); }

/* ===================== DRAW ===================== */
svg.onmousedown = e => {
  startX=e.offsetX; startY=e.offsetY;
  if(tool==="select"){ select(e.target); return; }
  current=create(tool,startX,startY);
  if(current) svg.appendChild(current);
};
svg.onmousemove = e => {
  if(!current) return;
  let x=e.offsetX,y=e.offsetY;
  if(tool==="rect"){
    current.setAttribute("x",Math.min(x,startX));
    current.setAttribute("y",Math.min(y,startY));
    current.setAttribute("width",Math.abs(x-startX));
    current.setAttribute("height",Math.abs(y-startY));
  }
  if(tool==="ellipse"){
    current.setAttribute("cx",(x+startX)/2);
    current.setAttribute("cy",(y+startY)/2);
    current.setAttribute("rx",Math.abs(x-startX)/2);
    current.setAttribute("ry",Math.abs(y-startY)/2);
  }
};
svg.onmouseup=()=>current=null;

function create(t,x,y){
  let e;
  if(t==="rect"){ e=document.createElementNS(ns,"rect"); e.setAttribute("fill","none"); e.setAttribute("stroke","black"); }
  if(t==="ellipse"){ e=document.createElementNS(ns,"ellipse"); e.setAttribute("fill","none"); e.setAttribute("stroke","black"); }
  if(t==="line"){ e=document.createElementNS(ns,"line"); e.setAttribute("x1",x);e.setAttribute("y1",y);e.setAttribute("x2",x);e.setAttribute("y2",y);e.setAttribute("stroke","black"); }
  if(t==="triangle"){ e=document.createElementNS(ns,"polygon"); e.setAttribute("stroke","black"); e.setAttribute("fill","none"); }
  if(t==="text"){
    let txt=prompt("Texte");
    if(!txt) return null;
    e=document.createElementNS(ns,"text");
    e.setAttribute("x",x); e.setAttribute("y",y);
    e.textContent=txt;
  }
  return e;
}

/* ===================== SELECTION ===================== */
function select(el){
  if(el===svg) return;
  if(selected) selected.classList.remove("selected");
  selected=el;
  selected.classList.add("selected");
  createHandles();
}

/* ===================== HANDLES ===================== */
function createHandles(){
  removeHandles();
  if(!selected.getBBox) return;
  let b=selected.getBBox();
  let pts=[
    [b.x,b.y],[b.x+b.width,b.y],
    [b.x,b.y+b.height],[b.x+b.width,b.y+b.height]
  ];
  const cursors = ["nw-resize","ne-resize","sw-resize","se-resize"];
  pts.forEach((p,i)=>{
    let h=document.createElementNS(ns,"rect");
    h.setAttribute("x",p[0]-4);
    h.setAttribute("y",p[1]-4);
    h.setAttribute("width",8);
    h.setAttribute("height",8);
    h.style.cursor = cursors[i];
    h.classList.add("handle");
    h.onmousedown=e=>resize(e,p);
    svg.appendChild(h);
    handles.push(h);
  });

  // rotation
  let r=document.createElementNS(ns,"circle");
  r.setAttribute("cx",b.x+b.width/2);
  r.setAttribute("cy",b.y-20);
  r.setAttribute("r",6);
  r.classList.add("rotate");
  r.onmousedown=startRotate;
  svg.appendChild(r);
  handles.push(r);
}

function removeHandles(){ handles.forEach(h=>h.remove()); handles=[]; }

/* ===================== RESIZE ===================== */
function resize(e, origin) {
  e.stopPropagation();

  const box = selected.getBBox();
  const isEllipse = selected.tagName === "ellipse";

  svg.onmousemove = ev => {
    let x = ev.offsetX;
    let y = ev.offsetY;

    let w = Math.abs(x - origin[0]);
    let h = Math.abs(y - origin[1]);

    if (isEllipse) {
      selected.setAttribute("rx", w / 2);
      selected.setAttribute("ry", h / 2);
      selected.setAttribute("cx", origin[0] + w / 2);
      selected.setAttribute("cy", origin[1] + h / 2);
    } else {
      selected.setAttribute("x", Math.min(x, origin[0]));
      selected.setAttribute("y", Math.min(y, origin[1]));
      selected.setAttribute("width", w);
      selected.setAttribute("height", h);
    }
  };

  svg.onmouseup = () => {
    svg.onmousemove = null;
    createHandles();
  };
}

/* ===================== ROTATE ===================== */
function startRotate(e){
  e.stopPropagation();
  let box=selected.getBBox();
  let cx=box.x+box.width/2;
  let cy=box.y+box.height/2;
  svg.onmousemove=ev=>{
    let a=Math.atan2(ev.offsetY-cy,ev.offsetX-cx)*180/Math.PI;
    selected.setAttribute("transform",`rotate(${a} ${cx} ${cy})`);
  };
  svg.onmouseup=()=>{ svg.onmousemove=null; };
}

/* ===================== KEYBOARD MOVE ===================== */
document.onkeydown = e => {
  if (!selected) return;

  let step = e.shiftKey ? 10 : 1;
  let dx = 0, dy = 0;

  if (e.key === "ArrowLeft") dx = -step;
  if (e.key === "ArrowRight") dx = step;
  if (e.key === "ArrowUp") dy = -step;
  if (e.key === "ArrowDown") dy = step;
  if (!dx && !dy) return;

  e.preventDefault();

  let t = selected.getAttribute("transform") || "";
  t += ` translate(${dx},${dy})`;
  selected.setAttribute("transform", t);

  createHandles();
};

/* ===================== EXPORT SVG ===================== */
function exportSVG() {
  removeHandles();
  let clone = svg.cloneNode(true);
  let blob = new Blob([clone.outerHTML], { type: "image/svg+xml" });
  download(blob, "dessin.svg");
  createHandles();
}

/* ===================== EXPORT PNG ===================== */
function exportPNG(){
  let img=new Image();
  let data="data:image/svg+xml;base64,"+btoa(svg.outerHTML);
  img.onload=()=>{
    let c=document.createElement("canvas");
    c.width=svg.clientWidth;
    c.height=svg.clientHeight;
    c.getContext("2d").drawImage(img,0,0);
    c.toBlob(b=>download(b,"dessin.png"));
  };
  img.src=data;
}

/* ===================== UTIL ===================== */
function download(blob,name){
  let a=document.createElement("a");
  a.href=URL.createObjectURL(blob);
  a.download=name;
  a.click();
}
</script>
</body>
</html>
